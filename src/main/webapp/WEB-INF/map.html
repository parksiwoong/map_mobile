<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>지도</title>
	<style>
		/*  주차마크공간 css */
		#mapwrap{position:relative;overflow:hidden;}
		.title {font-weight:bold;display:block;}
		.hAddr {position:absolute;left: 50%; transform: translateX(-50%); top: 91px;color: #f3f3f3; border-radius: 2px;background:#fff;background:rgb(75 75 75 / 80%);z-index:1;padding:5px;}
		#centerAddr {display:block;margin-top:2px;font-weight: normal;}
		/* 상세주소 */
		.hAddr_detail {position:absolute; height:100px; top: 239px;color: #f3f3f3;  border-radius: 2px;background:#fff;background:rgb(75 75 75 / 80%);z-index:1;padding:5px;}
		.title_detail {font-weight:bold;display:block;}
	</style>
		<script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=7c8813225e2ee056ab75aed39e98847d&libraries=services,clusterer,drawing"></script>
		<script src="http://developers.kakao.com/sdk/js/kakao.min.js"></script>
		<link rel="stylesheet"  href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
		<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script	src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<body style="margin: 0px; padding: 0px;">

		<!-- 팝업식 주소알아내기 -->
		<div class="hAddr_detail">
			<input type='BUTTON' value=" 창닫기" onClick='self.close()'>

			<span class="title_detail">지도중심기준 상세 주소정보</span>
			<span id="centerAddr"></span>
		</div>

		<!-- 지도가 표시될 div // currentMap-->
		<div id="currentMap" style="position:relative; width:100%; height: calc(100vw);">
			<div id="map" style="postition:absolute; overflow:hidden; width:100%;height:100%;"></div>
			<div class="dtladdress" id="dtladdress" style="postition:absolute; top:70%; width:100%;height:30%;">

			</div>
		</div>
	<script>
		/* 	var detailAdd = marker.info; */

		var bgMapCont = document.getElementById('map');
		var options = {
			center: new kakao.maps.LatLng(37.566124, 126.998995),
			level: 3
		};
		var mapApi = new kakao.maps.Map(bgMapCont , options);



		// 마우스 S드래그로 지도 이동이 완료되었을 때 마지막 파라미터로 넘어온 함수를 호출하도록 이벤트를 등록합니다
		daum.maps.event.addListener(mapApi, 'dragend', function() {
			fn_getMapInfo();
		});

		// 지도가 확대 또는 축소되면 마지막 파라미터로 넘어온 함수를 호출하도록 이벤트를 등록합니다
		daum.maps.event.addListener(mapApi, 'zoom_changed', function() {
			fn_getMapInfo();
		});

		function fn_getMapInfo(){
			// 지도 레벨
			var currLevel = mapApi.getLevel();

			positions = [];

			// 지도 중심좌표를 얻어옵니다
			var latlng = mapApi.getCenter();
			// 지도의 현재 영역을 얻어옵니다
			var bounds = mapApi.getBounds();
			// 영역의 남서쪽 좌표를 얻어옵니다
			var swLatLng = bounds.getSouthWest();
			// 영역의 북동쪽 좌표를 얻어옵니다
			var neLatLng = bounds.getNorthEast();

			//searchParkingList(swLatLng, neLatLng);
			//searchParkingList(swLatLng.getLng(),swLatLng.getLat(), neLatLng.getLng(), neLatLng.getLat() );
			getParkginSearch(0,0);
		}


		function getParkginSearch ( topleft, bottomright ){

			var infoLayer = {};
			infoLayer.jsonUrl = "/mpis/pub/eai/list/box2.do";
			infoLayer.sGpsX = "126.99584632422851";
			infoLayer.eGpsX = "127.00211667363638";
			infoLayer.sGpsY = "37.55929372909084";
			infoLayer.eGpsY = "37.56717750215049";

			$.ajax({
				url: '/mpis/getMpisData2.do',
				async:true,// false 일 경우 동기 요청으로 변경
				type:'POST', // GET, PUT
				data: infoLayer,// 전송할 데이터
				dataType:'text',// xml, json, script, html
				beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
				success:function(jqXHR) {
					drawMaker(jqXHR);
				},// 요청 완료 시
				error:function(jqXHR) {},// 요청 실패.
				complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
			});
		}

		var markerList=[];

		function drawMaker(position){
			var list = JSON.parse(position);

			clearMarker();
			$("#dtladdress").children().remove();
				$.each(list.list, function(i, item){
					var markerPosition  = new kakao.maps.LatLng(item.localY, item.localX );
					var marker = new kakao.maps.Marker({
					position: markerPosition
				});
				var infowindow = new kakao.maps.InfoWindow({
					content: item.localX // 인포윈도우에 표시할 내용
				});

				marker.info = item;
				marker.setMap(mapApi);
				markerList.push(marker);

				kakao.maps.event.addListener(marker, 'click', function(){   //마커 클릭시 이벤트
					console.log(marker.info);
					$("#dtladdress").append("<li>"+item.buldSn+"</li>");  // ajax 로 html li 에 보내는거
				} );
			});
		}
		function clearMarker(){
			$(markerList).each(function(idx){
				this.setMap(null);
			});
			makerList =[];
		}
	</script>
		<div style="position: absolute; padding: 10px; top: 10px; width: 100%; height: 40px; background-color: #aaa; z-index: 99999;">
			<input type="text" style="width: 100%; height: 20px;" id="searchKey">
				<a href="search.html" data-transition="flip" class="ui-btn ui-corner-all ui-shadow ui-btn-inline">page</a>
			</td>
		</div>
	</body>
</html>
